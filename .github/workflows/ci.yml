name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Cancel in-progress runs on new pushes to same branch to save CI time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline

    - name: Run ESLint
      timeout-minutes: 3
      run: npm run lint

  type-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline

    - name: Run TypeScript type check
      timeout-minutes: 3
      run: npm run check

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline

    - name: Generate static data
      run: npx tsx scripts/build-static.ts
      env:
        VITE_STATIC_BUILD: 'true'

    - name: Run tests with coverage
      timeout-minutes: 3
      run: npm run test:run -- --coverage
      env:
        NODE_ENV: 'test'

    - name: Display coverage summary
      if: always()
      run: |
        if [ -f "coverage/coverage-summary.json" ]; then
          echo "Coverage Summary:"
          cat coverage/coverage-summary.json
        fi

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: coverage/
        retention-days: 30

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline

    - name: Generate static data
      run: npx tsx scripts/build-static.ts
      env:
        VITE_STATIC_BUILD: 'true'

    - name: Build application
      timeout-minutes: 4
      run: |
        # Optimize build environment for large React app
        export NODE_OPTIONS="--max-old-space-size=8192 --max-semi-space-size=2048"
        export VITE_BUILD_TARGET="ci"

        # Build with optimizations
        npm run build
      env:
        NODE_ENV: 'production'
        VITE_STATIC_BUILD: 'true'
        VITE_SITE_TITLE: 'Awesome Video Dashboard'
        VITE_SITE_DESCRIPTION: 'A curated collection of awesome video resources and tools'
        VITE_DEFAULT_THEME: 'red'

    - name: Verify build artifacts
      run: |
        # Check that dist directories were created
        if [ ! -d "dist/public" ]; then
          echo "Error: dist/public directory not found"
          exit 1
        fi
        if [ ! -f "dist/index.js" ]; then
          echo "Error: dist/index.js not found"
          exit 1
        fi

        # Display build output structure
        echo "Build artifacts verified successfully"
        echo "Build output structure:"
        ls -lh dist/
        if [ -d "dist/public" ]; then
          echo "Public assets:"
          ls -lh dist/public/ | head -20
        fi

    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30

  # This job serves as a single required status check for branch protection
  # It will fail if any of the dependent jobs fail, blocking PR merges
  ci-success:
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, build]
    if: always()

    steps:
    - name: Check all jobs status
      run: |
        # Check if any required job failed
        if [ "${{ needs.lint.result }}" != "success" ]; then
          echo "❌ Lint job failed"
          exit 1
        fi
        if [ "${{ needs.type-check.result }}" != "success" ]; then
          echo "❌ Type check job failed"
          exit 1
        fi
        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "❌ Test job failed"
          exit 1
        fi
        if [ "${{ needs.build.result }}" != "success" ]; then
          echo "❌ Build job failed"
          exit 1
        fi

        echo "✅ All CI checks passed successfully"
